#!/usr/bin/env ruby
require "io/console"

# 下段にランダムに数字を入れます
# 上の段に下3個の平均を入れます
# さら上の段に下4個の平均を入れます
# 数字によって色づけをします
# 下段の数字を変えます
# 細かくします
# もっと細かくします
# ノイズを足します
def main
  Kernel.srand ARGV[0].to_i if ARGV[0]

  window_height, window_width = IO.console.winsize # [height, width]
  terminal = Array.new(window_height) { Array.new(window_width) }

  # 下段にランダムに数字を入れます
  last_row = terminal[-1]
  last_row.fill { rand(100) }

  # 上の段に下3個の平均を入れます
  next_row = terminal[-2]
  next_row.fill { |i|
    case i
    when 0
      (last_row[i] + last_row[i+1]) / 2
    when window_width - 1
      (last_row[i-1] + last_row[i]) / 2
    else
      (last_row[i-1] + last_row[i] + last_row[i+1]) / 3
    end
  }

  # さら上の段に下4個の平均を入れます
  (window_height - 2).times do |i|
    row = terminal[window_height - (3 + i)]
    row_1 = terminal[window_height - (2 + i)]
    row_2 = terminal[window_height - (1 + i)]
    row.fill { |j|
      case j
      when 0
        (row_1[j] + row_1[j+1] + row_2[j]) / 3
      when window_width - 1
        (row_1[j-1] + row_1[j] + row_2[j]) / 3
      else
        (row_1[j-1] + row_1[j] + row_1[j+1] + row_2[j]) / 4
      end
    }
  end
  p terminal[0]
end

main
